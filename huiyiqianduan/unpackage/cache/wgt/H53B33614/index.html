<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PDF阅读器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript">
        document.addEventListener('plusready', function(){
            //console.log("所有plus api都应该在此事件发生后调用，否则会出现plus is undefined。")
        });

        // 指定workerSrc
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let canvas = null;
        let ctx = null;

        window.onload = function() {
            canvas = document.getElementById('pdf-canvas');
            ctx = canvas.getContext('2d');

            // 加载PDF文件
            loadPDF('test.pdf');

            // 绑定按钮事件
            document.getElementById('prev').addEventListener('click', onPrevPage);
            document.getElementById('next').addEventListener('click', onNextPage);
            document.getElementById('zoomIn').addEventListener('click', () => {
                scale *= 1.2;
                queueRenderPage(pageNum);
            });
            document.getElementById('zoomOut').addEventListener('click', () => {
                scale /= 1.2;
                queueRenderPage(pageNum);
            });
        };

        function loadPDF(url) {
            // 显示加载提示
            document.getElementById('loading').style.display = 'block';

            pdfjsLib.getDocument(url).promise.then(function(pdf) {
                pdfDoc = pdf;
                document.getElementById('page-count').textContent = pdf.numPages;
                document.getElementById('loading').style.display = 'none';
                renderPage(pageNum);
            }).catch(function(error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                console.error('Error loading PDF:', error);
            });
        }

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                let viewport = page.getViewport({scale: scale});
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                let renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                page.render(renderContext).promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });

                document.getElementById('page-num').textContent = num;
            });
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button id="prev">上一页</button>
            <span>第 <span id="page-num"></span> 页 / 共 <span id="page-count"></span> 页</span>
            <button id="next">下一页</button>
            <button id="zoomIn">放大</button>
            <button id="zoomOut">缩小</button>
        </div>
        <div id="loading" class="message">正在加载PDF文件...</div>
        <div id="error" class="message error">PDF文件加载失败</div>
        <div class="canvas-container">
            <canvas id="pdf-canvas"></canvas>
        </div>
    </div>
</body>
</html>