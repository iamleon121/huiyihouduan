<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ZIP文件解压示例</title>
    <script src="js/jszip.min.js"></script>
    <style>
        body { max-width: 800px; margin: 20px auto; padding: 20px; }
        #fileList { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        .file-item { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        img.preview { max-width: 300px; margin-top: 10px; display: block; }
        .error { color: red; }
        .success { color: green; }
        .input-group { margin: 15px 0; }
        input[type="text"] { width: 70%; padding: 8px; }
        button { padding: 8px 15px; cursor: pointer; background-color: #4CAF50; color: white; border: none; }
        button:hover { background-color: #45a049; }
        .progress-container { margin-top: 10px; width: 100%; background-color: #f1f1f1; }
        .progress-bar { height: 20px; background-color: #4CAF50; width: 0%; }
    </style>
	<script type="text/javascript">
	    if(window.plus){  
	        plusReady();  
	    }else{   
	        document.addEventListener("plusready", plusReady, false);  
	    }  
	    // 扩展API准备完成后要执行的操作  
	    function plusReady(){  
	        var ws = plus.webview.currentWebview(); //pw回车可输出plus.webview  
	        // ... code  
	    } 
		function openNewWebview(){  
		  var wv = plus.webview.create('http://www.dcloud.io/');  
		  wv.show();  
		}
	</script>
</head>
<body>
    <h1>ZIP文件解压演示</h1>
    <button onclick="openNewWebview()">打开</button>
    <div class="input-group">
        <input type="text" id="zipUrl" placeholder="输入ZIP文件URL，例如：https://example.com/file.zip" />
        <button id="downloadBtn">下载并解压</button>
    </div>
    
    <div class="input-group">
        <p>或者从本地上传：</p>
        <input type="file" id="zipFile" accept=".zip" />
    </div>
    
    <div id="status"></div>
    <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="fileList"></div>

    <script>
        // 在页面加载时测试JSZip库
        window.addEventListener('load', async () => {
            try {
                const zip = new JSZip();
                zip.file("test.txt", "JSZip测试成功");
                await zip.generateAsync({type:"blob"});
                console.log('JSZip库加载测试成功');
                statusDiv.textContent = 'JSZip库加载成功，可以开始使用';
                statusDiv.className = 'success';
            } catch (err) {
                console.error('JSZip库加载测试失败:', err);
                statusDiv.textContent = 'JSZip库加载失败，请检查网络连接';
                statusDiv.className = 'error';
            }
        });

        const zipFileInput = document.getElementById('zipFile');
        const zipUrlInput = document.getElementById('zipUrl');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileListDiv = document.getElementById('fileList');
        const statusDiv = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        // 设置默认URL
        const defaultZipUrl = 'http://123.56.40.178/data.zip';
        zipUrlInput.value = defaultZipUrl;

        // 网络下载ZIP文件功能
        downloadBtn.addEventListener('click', async () => {
            const url = zipUrlInput.value.trim() || defaultZipUrl;
            if (!url) {
                statusDiv.textContent = '请输入有效的ZIP文件URL';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = '正在下载...';
            statusDiv.className = '';
            fileListDiv.innerHTML = '';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const contentLength = response.headers.get('content-length');
                const reader = response.body.getReader();
                const chunks = [];
                let receivedLength = 0;

                while(true) {
                    const {done, value} = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    receivedLength += value.length;

                    if (contentLength) {
                        const progress = (receivedLength / parseInt(contentLength)) * 100;
                        progressBar.style.width = `${Math.round(progress)}%`;
                        statusDiv.textContent = `下载进度: ${Math.round(progress)}%`;
                    }
                }

                const arrayBuffer = new Uint8Array(receivedLength);
                let position = 0;
                for(const chunk of chunks) {
                    arrayBuffer.set(chunk, position);
                    position += chunk.length;
                }

                const zip = new JSZip();
                const data = await zip.loadAsync(arrayBuffer);
                
                const fileEntries = Object.entries(data.files)
                    .filter(([name, entry]) => !entry.dir);

                statusDiv.textContent = `找到 ${fileEntries.length} 个文件`;
                progressContainer.style.display = 'none';

                for (const [fileName, fileEntry] of fileEntries) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    fileItem.innerHTML = `
                        <div><strong>文件名：</strong>${fileName}</div>
                        <div><strong>大小：</strong>${fileEntry._data.uncompressedSize} 字节</div>
                    `;

                    if (/\.(png|jpe?g|gif|webp)$/i.test(fileName)) {
                        try {
                            const imgBlob = await fileEntry.async('blob');
                            const imgUrl = URL.createObjectURL(imgBlob);
                            const img = new Image();
                            img.onload = () => URL.revokeObjectURL(imgUrl);
                            img.className = 'preview';
                            img.src = imgUrl;
                            fileItem.appendChild(img);
                        } catch (err) {
                            console.error('图片处理失败:', err);
                        }
                    }

                    if (/\.(txt|html?|css|js|json|xml)$/i.test(fileName)) {
                        try {
                            const textContent = await fileEntry.async('text');
                            const pre = document.createElement('pre');
                            pre.textContent = textContent;
                            fileItem.appendChild(pre);
                        } catch (err) {
                            console.error('文本处理失败:', err);
                        }
                    }

                    fileListDiv.appendChild(fileItem);
                }

            } catch (err) {
                statusDiv.textContent = `下载或解压失败: ${err.message}`;
                statusDiv.className = 'error';
                progressContainer.style.display = 'none';
            }
        });

        zipFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0]; // 获取第一个文件
            if (!file) return;

            // 添加文件大小限制（100MB）
            const MAX_SIZE = 100 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                statusDiv.textContent = '文件过大，请选择100MB以下的ZIP文件';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = '解压中...';
            statusDiv.className = '';
            fileListDiv.innerHTML = '';
            
            try {
                const reader = new FileReader();
                
                // 添加进度显示
                reader.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const progress = Math.round((event.loaded / event.total) * 100);
                        statusDiv.textContent = `读取中: ${progress}%`;
                    }
                };
                
                // 成功读取回调
                reader.onload = async (event) => {
                    try {
                        const zip = new JSZip();
                        const data = await zip.loadAsync(event.target.result);
                        
                        const fileEntries = Object.entries(data.files)
                            .filter(([name, entry]) => !entry.dir); // 过滤目录

                        // 显示文件总数
                        statusDiv.textContent = `找到 ${fileEntries.length} 个文件`;

                        // 遍历处理每个文件
                        for (const [fileName, fileEntry] of fileEntries) {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            
                            // 基础信息
                            fileItem.innerHTML = `
                                <div><strong>文件名：</strong>${fileName}</div>
                                <div><strong>大小：</strong>${fileEntry._data.uncompressedSize} 字节</div>
                            `;

                            // 图片预览处理
                            if (/\.(png|jpe?g|gif|webp)$/i.test(fileName)) {
                                try {
                                    const imgBlob = await fileEntry.async('blob');
                                    const imgUrl = URL.createObjectURL(imgBlob);
                                    const img = new Image();
                                    img.onload = () => URL.revokeObjectURL(imgUrl);
                                    img.className = 'preview';
                                    img.src = imgUrl;
                                    fileItem.appendChild(img);
                                } catch (err) {
                                    console.error('图片处理失败:', err);
                                }
                            }

                            // 文本内容显示
                            if (/\.(txt|html?|css|js|json|xml)$/i.test(fileName)) {
                                try {
                                    const textContent = await fileEntry.async('text');
                                    const pre = document.createElement('pre');
                                    pre.textContent = textContent;
                                    fileItem.appendChild(pre);
                                } catch (err) {
                                    console.error('文本处理失败:', err);
                                }
                            }

                            fileListDiv.appendChild(fileItem);
                        }

                    } catch (err) {
                        statusDiv.textContent = `解压失败: ${err.message}`;
                        statusDiv.className = 'error';
                    }
                };

                // 错误处理
                reader.onerror = () => {
                    statusDiv.textContent = '文件读取失败';
                    statusDiv.className = 'error';
                };

                // 关键修复：传递正确的Blob对象
                reader.readAsArrayBuffer(file);
                
            } catch (err) {
                statusDiv.textContent = `错误: ${err.message}`;
                statusDiv.className = 'error';
            }
        });
    </script>
</body>
</html>
