<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ZIP文件解压示例</title>
    <style>
        body { max-width: 800px; margin: 20px auto; padding: 20px; }
        #fileList { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        .file-item { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        img.preview { max-width: 300px; margin-top: 10px; display: block; }
        .error { color: red; }
        .success { color: green; }
        .input-group { margin: 15px 0; }
        input[type="text"] { width: 70%; padding: 8px; }
        button { padding: 8px 15px; cursor: pointer; background-color: #4CAF50; color: white; border: none; }
        button:hover { background-color: #45a049; }
        .progress-container { margin-top: 10px; width: 100%; background-color: #f1f1f1; }
        .progress-bar { height: 20px; background-color: #4CAF50; width: 0%; }
    </style>
</head>
<body>
    <h1>ZIP文件解压演示</h1>
    <div class="input-group">
        <input type="text" id="zipUrl" placeholder="输入ZIP文件URL，例如：https://example.com/file.zip" />
        <button id="downloadBtn">下载并解压</button>
    </div>
    
    <div class="input-group">
        <p>或者从本地上传：</p>
        <input type="file" id="zipFile" accept=".zip" />
    </div>
    
    <div id="status"></div>
    <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="fileList"></div>

    <script>
    if(window.plus) {
        plusReady();
    } else {
        document.addEventListener("plusready", plusReady, false);
    }

    function plusReady() {
        const zipFileInput = document.getElementById('zipFile');
        const zipUrlInput = document.getElementById('zipUrl');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileListDiv = document.getElementById('fileList');
        const statusDiv = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        // 设置默认URL
        const defaultZipUrl = 'http://123.56.40.178/data.zip';
        zipUrlInput.value = defaultZipUrl;

        // 网络下载ZIP文件功能
        downloadBtn.addEventListener('click', async () => {
            const url = zipUrlInput.value.trim() || defaultZipUrl;
            if (!url) {
                statusDiv.textContent = '请输入有效的ZIP文件URL';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = '正在下载...';
            statusDiv.className = '';
            fileListDiv.innerHTML = '';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                const dtask = plus.downloader.createDownload(url, {}, function(d, status) {
                    if (status == 200) {
                        decompressFile(d.filename);
                    } else {
                        statusDiv.textContent = '下载失败';
                        statusDiv.className = 'error';
                        progressContainer.style.display = 'none';
                    }
                });

                dtask.addEventListener("statechanged", function(task, status) {
                    switch(task.state) {
                        case 3:
                            const progress = (task.downloadedSize / task.totalSize) * 100;
                            progressBar.style.width = `${Math.round(progress)}%`;
                            statusDiv.textContent = `下载进度: ${Math.round(progress)}%`;
                            break;
                        case 4:
                            console.log("Download Failed");
                            break;
                    }
                });

                dtask.start();
            } catch (err) {
                statusDiv.textContent = `下载失败: ${err.message}`;
                statusDiv.className = 'error';
                progressContainer.style.display = 'none';
            }
        });

        // 本地文件处理
        zipFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const MAX_SIZE = 100 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                statusDiv.textContent = '文件过大，请选择100MB以下的ZIP文件';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = '准备解压...';
            statusDiv.className = '';
            fileListDiv.innerHTML = '';
            
            // 获取本地文件路径
            const fileURL = plus.io.convertLocalFileSystemURL(file.path);
            decompressFile(fileURL);
        });

        // 解压文件
        function decompressFile(zipPath) {
            const targetPath = '_doc/unzip/';
            
            plus.zip.decompress(zipPath, targetPath, (success) => {
                statusDiv.textContent = '解压完成';
                statusDiv.className = 'success';
                progressContainer.style.display = 'none';
                
                // 列出解压后的文件
                plus.io.resolveLocalFileSystemURL(targetPath, (entry) => {
                    const directoryReader = entry.createReader();
                    directoryReader.readEntries((entries) => {
                        entries.forEach((fileEntry) => {
                            if (!fileEntry.isDirectory) {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';
                                
                                fileItem.innerHTML = `
                                    <div><strong>文件名：</strong>${fileEntry.name}</div>
                                `;

                                // 处理图片预览
                                if (/\.(png|jpe?g|gif|webp)$/i.test(fileEntry.name)) {
                                    const img = document.createElement('img');
                                    img.className = 'preview';
                                    img.src = fileEntry.toLocalURL();
                                    fileItem.appendChild(img);
                                }

                                // 处理文本文件
                                if (/\.(txt|html?|css|js|json|xml)$/i.test(fileEntry.name)) {
                                    fileEntry.file((file) => {
                                        const reader = new plus.io.FileReader();
                                        reader.onloadend = function(evt) {
                                            const pre = document.createElement('pre');
                                            pre.textContent = evt.target.result;
                                            fileItem.appendChild(pre);
                                        };
                                        reader.readAsText(file);
                                    });
                                }

                                fileListDiv.appendChild(fileItem);
                            }
                        });
                    });
                });
            }, (error) => {
                statusDiv.textContent = `解压失败: ${error.message}`;
                statusDiv.className = 'error';
                progressContainer.style.display = 'none';
            });
        }
    }
    </script>
</body>
</html>
