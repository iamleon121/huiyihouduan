# 分布式文件服务架构设计

## 目录

1. [设计背景](#设计背景)
2. [架构概述](#架构概述)
3. [系统组件](#系统组件)
4. [数据流](#数据流)
5. [关键机制](#关键机制)
6. [扩展性设计](#扩展性设计)
7. [安全考虑](#安全考虑)
8. [性能优化](#性能优化)

## 设计背景

无纸化会议系统需要向前端客户端提供会议文件下载服务。随着系统使用规模的扩大，单一服务器的下载能力成为瓶颈，影响用户体验。为了解决这个问题，我们设计了分布式文件服务架构，将文件下载负载分散到多个节点，提高系统整体性能和可用性。

### 现有系统限制

1. **单点负载**：所有下载请求都发送到主控服务器，造成负载集中
2. **资源竞争**：文件下载占用大量I/O资源，影响其他API服务
3. **扩展性差**：难以通过增加服务器数量来提高下载能力
4. **单点故障**：主控服务器故障会导致整个系统不可用

### 设计目标

1. **减轻主控服务器负载**：将文件下载任务分散到多个分布式节点
2. **保持前端兼容性**：不修改前端代码，保持现有的API调用方式
3. **提高系统可用性**：通过多节点部署减少单点故障风险
4. **简化部署和管理**：节点可以独立部署和管理，支持动态扩展
5. **优化用户体验**：提高文件下载速度和成功率

## 架构概述

分布式文件服务架构采用"中心辐射型"设计模式，由一个主控服务器和多个分布式文件服务节点组成。主控服务器负责会议管理和API提供，分布式节点负责文件存储和下载服务。

### 架构图

```
┌─────────┐     1. 状态轮询     ┌─────────────┐
│  前端   │ -----------------> │ 主控服务器  │
│ 客户端  │ <----------------- │             │
└─────────┘     2. 返回状态     └──────┬──────┘
     │                                 │
     │                                 │ 5. 同步会议文件
     │                                 │
     │                                 ▼
     │ 3. 获取会议数据         ┌─────────────┐
     └ ----------------------> │ 主控服务器  │
       <---------------------- │             │
         4. 返回数据           └──────┬──────┘
                                      │
     ┌─────────────────────────┐      │
     │                         │      │
     │ 6. 请求下载文件         │      │
     ▼                         │      │
┌─────────┐                    │    ┌─┴───────────┐
│  前端   │ -------------------┴--> │ 主控服务器  │
│ 客户端  │ <---------------------- │             │
└─────────┘    7. 重定向到节点      └─────────────┘
     │
     │ 8. 跟随重定向
     ▼
┌─────────────┐
│ 分布式节点  │
│             │
└─────────────┘
     │
     │ 9. 返回文件数据
     ▼
┌─────────┐
│  前端   │
│ 客户端  │
└─────────┘
```

### 设计原则

1. **职责分离**：主控服务器负责会议管理，分布式节点负责文件服务
2. **透明重定向**：通过HTTP重定向实现前端无感知的分布式下载
3. **自动同步**：分布式节点自动从主控服务器同步会议文件
4. **容错设计**：当分布式节点不可用时，回退到主控服务器提供服务
5. **简单实用**：优先考虑简单可靠的实现，避免过度工程化

## 系统组件

### 1. 主控服务器

主控服务器是系统的核心，负责：

- 提供会议管理API接口
- 存储会议元数据和状态信息
- 管理分布式节点注册和状态
- 实现下载请求的重定向
- 作为分布式节点的数据源

#### 关键API

- `/api/v1/meetings/status/token`：获取会议状态
- `/api/v1/meetings/{meeting_id}/data`：获取会议数据
- `/api/v1/meetings/{meeting_id}/download-package`：下载会议文件包（重定向）
- `/api/v1/meetings/{meeting_id}/download-package-direct`：直接下载会议文件包（供节点同步）
- `/api/v1/nodes/register`：节点注册
- `/api/v1/nodes/unregister`：节点注销
- `/api/v1/nodes/list`：获取节点列表

### 2. 分布式文件服务节点

分布式文件服务节点负责：

- 定期从主控服务器同步会议数据
- 存储会议相关文件
- 提供文件下载服务
- 向主控服务器报告自身状态

#### 关键API

- `/api/v1/meetings/{meeting_id}/download-package`：下载会议文件包
- `/health`：健康检查

### 3. 前端客户端

前端客户端是无纸化会议系统的用户界面，负责：

- 轮询会议状态
- 获取会议数据
- 下载会议文件
- 显示会议内容

## 数据流

### 1. 节点注册流程

```
┌─────────────┐                           ┌─────────────┐
│ 分布式节点  │                           │ 主控服务器  │
└──────┬──────┘                           └──────┬──────┘
       │                                         │
       │ 1. POST /api/v1/nodes/register          │
       │ {node_id, address, status}              │
       │---------------------------------------->│
       │                                         │
       │ 2. 200 OK                               │
       │ {status: "success"}                     │
       │<----------------------------------------│
       │                                         │
       │ 3. 定期发送心跳                         │
       │---------------------------------------->│
       │                                         │
```

### 2. 会议同步流程

```
┌─────────────┐                           ┌─────────────┐
│ 分布式节点  │                           │ 主控服务器  │
└──────┬──────┘                           └──────┬──────┘
       │                                         │
       │ 1. GET /api/v1/meetings/status/token    │
       │---------------------------------------->│
       │                                         │
       │ 2. 200 OK                               │
       │ {id: "token", meetings: [...]}          │
       │<----------------------------------------│
       │                                         │
       │ 3. 检测到活动会议                       │
       │                                         │
       │ 4. GET /api/v1/meetings/{id}/download-package-direct
       │---------------------------------------->│
       │                                         │
       │ 5. 200 OK                               │
       │ [文件数据]                              │
       │<----------------------------------------│
       │                                         │
       │ 6. 保存文件                             │
       │                                         │
```

### 3. 文件下载流程

```
┌─────────┐         ┌─────────────┐         ┌─────────────┐
│  前端   │         │ 主控服务器  │         │ 分布式节点  │
└────┬────┘         └──────┬──────┘         └──────┬──────┘
     │                     │                       │
     │ 1. GET /api/v1/meetings/{id}/download-package
     │-------------------->│                       │
     │                     │                       │
     │ 2. 302 Found        │                       │
     │ Location: http://{node}/api/v1/meetings/{id}/download-package
     │<--------------------│                       │
     │                     │                       │
     │ 3. GET /api/v1/meetings/{id}/download-package
     │---------------------------------------------->│
     │                     │                       │
     │ 4. 200 OK           │                       │
     │ [文件数据]          │                       │
     │<----------------------------------------------│
     │                     │                       │
```

## 关键机制

### 1. HTTP重定向机制

主控服务器使用HTTP 302重定向将下载请求转发到分布式节点：

```python
@router.get("/{meeting_id}/download-package")
async def download_meeting_package(meeting_id: str):
    # 获取可用的分布式节点
    available_nodes = await get_available_nodes()
    
    if available_nodes:
        # 选择一个分布式节点
        selected_node = select_node(available_nodes)
        node_url = f"http://{selected_node}/api/v1/meetings/{meeting_id}/download-package"
        
        # 返回重定向响应
        return RedirectResponse(url=node_url)
    else:
        # 如果没有可用节点，使用本地文件
        return await download_local_package(meeting_id)
```

### 2. 节点管理机制

主控服务器维护分布式节点的注册表，并定期检查节点健康状态：

```python
# 节点注册表
nodes_registry = {}

@router.post("/nodes/register")
async def register_node(node_info: dict):
    node_id = node_info.get("node_id")
    address = node_info.get("address")
    
    # 添加到注册表
    nodes_registry[node_id] = {
        "address": address,
        "status": "online",
        "last_seen": time.time()
    }
    
    return {"status": "success"}
```

### 3. 文件同步机制

分布式节点定期从主控服务器同步会议文件：

```python
async def sync_meeting_data(meeting_id):
    # 创建会议目录
    meeting_dir = os.path.join(STORAGE_PATH, "meeting_files", meeting_id)
    os.makedirs(meeting_dir, exist_ok=True)
    
    # 获取会议包
    package_path = os.path.join(meeting_dir, "package.zip")
    
    # 从主控服务器下载会议包
    session = await get_http_session()
    async with session.get(f"{MAIN_SERVER_URL}/api/v1/meetings/{meeting_id}/download-package-direct") as response:
        if response.status == 200:
            # 读取响应内容
            content = await response.read()
            
            # 保存到文件
            with open(package_path, "wb") as f:
                f.write(content)
            
            return True
    
    return False
```

### 4. 负载均衡机制

主控服务器实现简单的负载均衡算法，选择最佳的分布式节点：

```python
def select_node(nodes):
    """选择最佳节点"""
    # 简单实现：随机选择
    return random.choice(nodes)
    
    # 更复杂的实现可以考虑负载、响应时间等因素
```

## 扩展性设计

### 1. 水平扩展

系统支持通过增加分布式节点数量来提高整体下载能力：

- 新节点可以动态加入系统，无需重启主控服务器
- 节点可以部署在不同的地理位置，优化不同地区的访问速度
- 节点可以根据负载情况动态调整资源分配

### 2. 功能扩展

架构设计考虑了未来的功能扩展：

- 支持更复杂的负载均衡算法
- 支持基于地理位置的智能路由
- 支持文件缓存和预加载
- 支持增量同步和差异更新

### 3. 容错设计

系统具有良好的容错能力：

- 当分布式节点不可用时，自动回退到主控服务器
- 当主控服务器不可用时，分布式节点可以继续提供已同步的文件
- 支持节点自动恢复和重新注册

## 安全考虑

### 1. 节点认证

为确保只有授权的节点可以注册和同步文件，可以实现以下机制：

- 使用API密钥进行节点认证
- 实现IP白名单限制
- 使用HTTPS加密通信

### 2. 数据安全

保护文件数据的安全性：

- 实现文件完整性校验
- 考虑文件加密存储
- 实现访问控制和权限管理

### 3. 防护措施

防止系统被滥用：

- 实现请求限流
- 监控异常访问模式
- 记录详细的访问日志

## 性能优化

### 1. 缓存策略

实现多级缓存提高性能：

- 内存缓存热门文件
- 使用CDN加速静态文件分发
- 实现客户端缓存

### 2. 传输优化

优化文件传输效率：

- 实现文件压缩
- 支持断点续传
- 使用HTTP/2减少连接开销

### 3. 存储优化

优化文件存储方式：

- 使用高性能存储设备
- 实现文件分片存储
- 定期清理过期文件
