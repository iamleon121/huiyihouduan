# 无纸化会议系统编码规范

本文档定义了无纸化会议系统项目的编码规范和最佳实践，以确保代码质量、一致性和可维护性。

## 核心原则

- 编写简洁、技术准确的代码，附带适当的注释和文档
- 优先使用函数式和声明式编程风格；尽量避免不必要的类
- 优先选择迭代和模块化而非代码重复
- 使用描述性变量名，包含辅助动词（如 `is_active`, `has_permission`）
- 目录和文件名使用小写字母和下划线（如 `routers/user_routes.py`）
- 为路由和工具函数使用命名导出
- 使用接收对象、返回对象（RORO）模式

## Python/FastAPI 规范

### 函数定义

- 使用 `def` 定义纯函数，使用 `async def` 定义异步操作
- 为所有函数签名添加类型提示
- 优先使用 Pydantic 模型而非原始字典进行输入验证
- 文件结构：导出的路由器、子路由、工具函数、静态内容、类型（模型、模式）

### 代码风格

- 条件语句中避免不必要的花括号
- 对于单行语句的条件，省略花括号
- 对于简单的条件语句，使用简洁的单行语法（如 `if condition: do_something()`）
- 遵循 PEP 8 编码规范

## 错误处理和验证

### 错误处理最佳实践

- 在函数开始处处理错误和边缘情况
- 对错误条件使用提前返回，避免深度嵌套的 if 语句
- 将正常执行路径放在函数的最后，以提高可读性
- 避免不必要的 else 语句；使用 if-return 模式
- 使用守卫子句处理前置条件和无效状态
- 实现适当的错误日志记录和用户友好的错误消息
- 使用自定义错误类型或错误工厂实现一致的错误处理

## 项目依赖

- FastAPI
- Pydantic v2
- 异步数据库库（如 asyncpg 或 aiomysql）
- SQLAlchemy 2.0（如果使用 ORM 功能）
- Uvicorn（ASGI 服务器）
- Python-multipart（文件上传）
- PyMuPDF（PDF 处理）

## FastAPI 特定指南

### 组件和模型

- 使用函数组件（普通函数）和 Pydantic 模型进行输入验证和响应模式
- 使用声明式路由定义，带有明确的返回类型注解
- 使用 `def` 进行同步操作，使用 `async def` 进行异步操作

### 应用生命周期

- 最小化 `@app.on_event("startup")` 和 `@app.on_event("shutdown")`
- 优先使用 lifespan 上下文管理器管理启动和关闭事件
- 使用中间件进行日志记录、错误监控和性能优化

### 性能和错误处理

- 使用异步函数优化 I/O 绑定任务，使用缓存策略和延迟加载
- 对预期错误使用 HTTPException，并将其建模为特定的 HTTP 响应
- 使用中间件处理意外错误、日志记录和错误监控
- 使用 Pydantic 的 BaseModel 进行一致的输入/输出验证和响应模式

## 性能优化

### 异步和 I/O 操作

- 最小化阻塞 I/O 操作；对所有数据库调用和外部 API 请求使用异步操作
- 使用 Redis 或内存存储等工具为静态和频繁访问的数据实现缓存
- 使用 Pydantic 优化数据序列化和反序列化
- 对大型数据集和大型 API 响应使用延迟加载技术

### 关键约定

1. 依赖 FastAPI 的依赖注入系统管理状态和共享资源
2. 优先考虑 API 性能指标（响应时间、延迟、吞吐量）
3. 限制路由中的阻塞操作：
   - 优先使用异步和非阻塞流程
   - 对数据库和外部 API 操作使用专用的异步函数
   - 清晰地组织路由和依赖项，以优化可读性和可维护性

## 代码审查清单

在提交代码或进行代码审查时，请检查以下内容：

1. 代码是否遵循上述编码规范？
2. 是否有适当的错误处理？
3. 是否有适当的文档和注释？
4. 是否有不必要的代码重复？
5. 是否有性能问题？
6. 是否有安全问题？
7. 是否有适当的测试？

## 参考资料

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [Pydantic 官方文档](https://docs.pydantic.dev/)
- [SQLAlchemy 官方文档](https://docs.sqlalchemy.org/)
- [PEP 8 -- Python 编码风格指南](https://www.python.org/dev/peps/pep-0008/)
- [PEP 257 -- 文档字符串约定](https://www.python.org/dev/peps/pep-0257/)

更新日期：2024年04月19日
