# 无纸化会议系统渐进式重构计划

## 背景与目标

当前的无纸化会议系统代码存在一些不符合最佳实践的问题，主要体现在main.py文件过长、函数过大、代码组织不够模块化等方面。为了提高代码的可读性、可维护性和性能，需要进行重构。

考虑到大规模重构可能引入新的错误和不稳定性，我们采用**渐进式重构**策略，通过小步骤、持续测试的方式逐步改进代码质量，同时保持系统的稳定性。

## 重构原则

1. **小步前进**：每次只修改一小部分代码
2. **频繁测试**：每次修改后立即测试
3. **版本控制**：每次成功的修改都提交到版本控制系统
4. **保持功能不变**：确保重构不改变程序的行为
5. **编写测试**：为关键功能编写测试，以便在重构过程中验证功能

## 重构计划

重构工作分为四个阶段，按风险从低到高排序：

### 第一阶段：代码组织和文档改进（低风险）

**目标**：提高代码可读性和可维护性，不改变代码行为

#### 1.1 提取工具函数（预计工作量：1天）

- 创建`utils.py`文件
- 将以下函数移动到utils.py：
  - `format_file_size`
  - `ensure_jpg_for_pdf`
  - `ensure_jpg_in_zip`
  - `convert_pdf_to_jpg_for_pad_sync`
  - `convert_pdf_to_jpg_for_pad`
- 在main.py中导入这些函数
- 测试确保功能正常

#### 1.2 添加文档和注释（预计工作量：2天）

- 为所有公共API端点添加或完善文档字符串
- 为复杂逻辑添加注释
- 确保文档符合PEP 257规范

#### 1.3 改进变量命名（预计工作量：1天）

- 将不够描述性的变量名替换为更清晰的名称
- 确保变量命名符合Python命名约定（蛇形命名法）

### 第二阶段：路由分离（中等风险）

**目标**：将路由按功能分离到不同文件，提高代码组织性

#### 2.1 创建路由目录结构（预计工作量：0.5天）

- 创建`routes`目录
- 创建以下文件：
  - `routes/__init__.py`
  - `routes/meetings.py`
  - `routes/documents.py`
  - `routes/users.py`
  - `routes/maintenance.py`
  - `routes/pdf_conversion.py`

#### 2.2 分离会议相关路由（预计工作量：1天）

- 将会议相关路由移动到`routes/meetings.py`
- 使用APIRouter
- 在main.py中导入并注册路由器
- 测试所有会议相关功能

#### 2.3 分离文档相关路由（预计工作量：1天）

- 将文档相关路由移动到`routes/documents.py`
- 使用APIRouter
- 在main.py中导入并注册路由器
- 测试所有文档相关功能

#### 2.4 分离用户相关路由（预计工作量：0.5天）

- 将用户相关路由移动到`routes/users.py`
- 使用APIRouter
- 在main.py中导入并注册路由器
- 测试所有用户相关功能

#### 2.5 分离维护相关路由（预计工作量：0.5天）

- 将维护相关路由移动到`routes/maintenance.py`
- 使用APIRouter
- 在main.py中导入并注册路由器
- 测试所有维护相关功能

#### 2.6 分离PDF转换相关路由（预计工作量：0.5天）

- 将PDF转换相关路由移动到`routes/pdf_conversion.py`
- 使用APIRouter
- 在main.py中导入并注册路由器
- 测试所有PDF转换相关功能

### 第三阶段：业务逻辑分离（中高风险）

**目标**：将业务逻辑从路由处理函数中提取出来，提高代码复用性和可测试性

#### 3.1 创建服务层目录结构（预计工作量：0.5天）

- 创建`services`目录
- 创建以下文件：
  - `services/__init__.py`
  - `services/meeting_service.py`
  - `services/file_service.py`
  - `services/user_service.py`
  - `services/pdf_service.py`

#### 3.2 提取文件处理逻辑（预计工作量：2天）

- 将以下函数移动到`services/file_service.py`：
  - `process_temp_files_in_meeting`
  - `process_temp_files_in_meeting_update`
  - `cleanup_temp_files`
  - `background_cleanup_task`
  - `background_cleanup_meetings_task`
- 测试文件处理功能

#### 3.3 提取会议处理逻辑（预计工作量：2天）

- 将会议相关业务逻辑移动到`services/meeting_service.py`
- 重构大型函数，如`get_meeting_package`、`download_meeting_package`
- 测试会议处理功能

#### 3.4 提取PDF处理逻辑（预计工作量：1天）

- 将PDF处理相关业务逻辑移动到`services/pdf_service.py`
- 测试PDF处理功能

#### 3.5 提取用户处理逻辑（预计工作量：0.5天）

- 将用户相关业务逻辑移动到`services/user_service.py`
- 测试用户处理功能

### 第四阶段：异步优化（高风险）

**目标**：优化异步处理，提高系统性能和稳定性

#### 4.1 统一异步模式（预计工作量：2天）

- 优化异步函数的使用方式
- 替换同步环境中创建新事件循环的模式
- 使用更现代的异步模式
- 测试所有异步功能

#### 4.2 使用lifespan上下文管理器（预计工作量：1天）

- 替换`@app.on_event("startup")`为lifespan上下文管理器
- 测试应用启动和关闭过程

#### 4.3 优化异步文件处理（预计工作量：1天）

- 改进文件上传和处理的异步方式
- 测试文件处理性能

## 测试策略

为了确保重构不破坏现有功能，我们将采用以下测试策略：

1. **手动功能测试**：每次重构后，手动测试受影响的功能
2. **自动化测试**：为关键功能编写自动化测试
3. **回归测试**：在每个阶段结束时进行全面的回归测试

## 风险管理

1. **回滚计划**：每次提交前确保有可回滚的版本
2. **功能验证**：每次重构后验证功能是否正常
3. **增量部署**：在测试环境中增量部署重构后的代码
4. **监控**：部署后密切监控系统性能和错误日志

## 时间估计

- 第一阶段：4个工作日
- 第二阶段：4个工作日
- 第三阶段：6个工作日
- 第四阶段：4个工作日

**总计**：约18个工作日（约3-4周）

## 优先级和执行顺序

1. 首先完成第一阶段（低风险）
2. 然后完成第二阶段（中等风险）
3. 接着完成第三阶段（中高风险）
4. 最后完成第四阶段（高风险）

每个阶段内部，按照列出的顺序执行各个任务。

## 成功标准

重构成功的标准包括：

1. 代码更加模块化，main.py文件大小减少至少70%
2. 所有功能正常工作，无新增bug
3. 代码可读性和可维护性提高
4. 系统性能保持不变或有所提升

## 后续工作

完成基本重构后，可以考虑以下改进：

1. 增加单元测试覆盖率
2. 实现更多的性能优化
3. 改进错误处理和日志记录
4. 考虑引入依赖注入容器
5. 优化数据库访问模式

---

*注：此计划可根据实际情况进行调整。每个阶段完成后应进行评估，决定是否需要修改后续阶段的计划。*
